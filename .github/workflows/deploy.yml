name: Build & Deploy to AWS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build backend image
        run: |
          docker build -t hms-backend:latest -f backend/Dockerfile backend

      - name: Build frontend image
        run: |
          docker build -t hms-frontend:latest -f frontend/Dockerfile --build-arg VITE_API_BASE_URL="" frontend

      - name: Save docker images
        run: |
          docker save hms-backend:latest hms-frontend:latest | gzip > hms-images.tar.gz

      - name: Upload docker images and compose file to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "hms-images.tar.gz,docker-compose.ec2.yml"
          target: "/tmp"

      # Deploy via SSH
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_DATABASE: ${{ secrets.DB_DATABASE }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: DB_HOST,DB_PORT,DB_DATABASE,DB_USERNAME,DB_PASSWORD,SECRET_KEY
          script: |
            set -e
            APP_DIR=${APP_DIR:-/var/www/hms}
            mkdir -p $APP_DIR

            echo "==== Docker Environment Check ===="
            # Ensure Docker is installed
            if ! command -v docker >/dev/null 2>&1; then
              echo "Installing Docker..."
              sudo apt-get update
              sudo apt-get install -y docker.io
              sudo systemctl enable --now docker
            fi
            docker --version

            # Ensure Docker Compose plugin is installed
            if ! docker compose version >/dev/null 2>&1; then
              echo "Installing Docker Compose plugin..."
              if ! apt-cache show docker-compose-plugin >/dev/null 2>&1; then
                sudo apt-get update
                sudo apt-get install -y ca-certificates curl gnupg lsb-release
                sudo mkdir -p /etc/apt/keyrings
                curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
                echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
              fi
              sudo apt-get update
              sudo apt-get install -y docker-compose-plugin
            fi
            docker compose version

            echo "==== Loading Docker Images ===="
            # Load images built on the runner
            docker load -i /tmp/hms-images.tar.gz

            # Verify images loaded
            echo "Verifying images..."
            docker images | grep hms-backend
            docker images | grep hms-frontend

            echo "==== Preparing Configuration ===="
            # Prepare compose and env file
            mv -f /tmp/docker-compose.ec2.yml $APP_DIR/docker-compose.ec2.yml
            # For EC2 docker-compose, the database runs as service name `db` on the compose network.
            echo "DB_DATABASE=$DB_DATABASE" > $APP_DIR/.env
            echo "DB_USERNAME=$DB_USERNAME" >> $APP_DIR/.env
            echo "DB_PASSWORD=$DB_PASSWORD" >> $APP_DIR/.env
            echo "DB_ROOT_PASSWORD=${DB_ROOT_PASSWORD:-$DB_PASSWORD}" >> $APP_DIR/.env
            echo "DATABASE_URL=mysql+asyncmy://$DB_USERNAME:$DB_PASSWORD@db:3306/$DB_DATABASE" >> $APP_DIR/.env
            echo "SECRET_KEY=$SECRET_KEY" >> $APP_DIR/.env

            echo "==== Starting Database (MySQL) ===="
            docker compose -f $APP_DIR/docker-compose.ec2.yml --env-file $APP_DIR/.env up -d db

            echo "==== Waiting for Database to be Healthy ===="
            for i in {1..60}; do
              if docker compose -f $APP_DIR/docker-compose.ec2.yml ps | grep -q "hms-db-mysql.*healthy"; then
                echo "Database is healthy!"
                break
              fi
              echo "Waiting for database... ($i/60)"
              sleep 2
              if [ "$i" -eq 60 ]; then
                echo "Database did not become healthy in time"
                docker compose -f $APP_DIR/docker-compose.ec2.yml logs --tail=200 db || true
                exit 1
              fi
            done

            echo "==== Running Database Migrations ===="
            # Run migrations with timeout
            timeout 300 docker compose -f $APP_DIR/docker-compose.ec2.yml --env-file $APP_DIR/.env run --rm backend alembic upgrade head || {
              echo "Migration failed or timed out"
              exit 1
            }

            echo "==== Starting Services ===="
            # Start services
            docker compose -f $APP_DIR/docker-compose.ec2.yml --env-file $APP_DIR/.env up -d --remove-orphans

            echo "==== Waiting for Services to Start ===="
            # Wait for backend to be healthy (up to 60 seconds)
            for i in {1..30}; do
              if docker compose -f $APP_DIR/docker-compose.ec2.yml ps | grep -q "hms-backend.*healthy"; then
                echo "Backend is healthy!"
                break
              fi
              echo "Waiting for backend... ($i/30)"
              sleep 2
            done

            # Check if frontend is running
            sleep 5
            if docker compose -f $APP_DIR/docker-compose.ec2.yml ps | grep -q "hms-frontend.*Up"; then
              echo "Frontend is running!"
            else
              echo "Warning: Frontend may not be running properly"
            fi

            echo "==== Container Status ===="
            docker compose -f $APP_DIR/docker-compose.ec2.yml ps

            # Show recent logs for debugging
            echo "==== Recent Backend Logs (last 20 lines) ===="
            docker compose -f $APP_DIR/docker-compose.ec2.yml logs --tail=20 backend || echo "Could not fetch backend logs"

            echo "==== Recent Frontend Logs (last 10 lines) ===="
            docker compose -f $APP_DIR/docker-compose.ec2.yml logs --tail=10 frontend || echo "Could not fetch frontend logs"

            echo "==== Cleanup ===="
            # Cleanup old images and tar file
            docker image prune -f
            rm -f /tmp/hms-images.tar.gz

            echo "==== Deployment Complete ===="

            echo "==== Verifying Services ===="
            # Test backend health endpoint
            sleep 3
            if curl -f http://localhost:8000/health 2>/dev/null || curl -f http://localhost:8000/ 2>/dev/null; then
              echo "âœ“ Backend is responding"
            else
              echo "âš  Backend health check failed (may need more time to start)"
            fi

            # Test frontend
            if curl -f http://localhost:80 2>/dev/null | grep -q "<!doctype html" || curl -f http://localhost 2>/dev/null | head -n 1 | grep -q "<"; then
              echo "âœ“ Frontend is serving content"
            else
              echo "âš  Frontend health check failed"
            fi

            echo ""
            echo "============================================"
            echo "ðŸš€ Deployment Summary"
            echo "============================================"
            echo "App Directory: $APP_DIR"
            echo "Backend URL: http://$(curl -s ifconfig.me):8000"
            echo "Frontend URL: http://$(curl -s ifconfig.me)"
            echo "============================================"
