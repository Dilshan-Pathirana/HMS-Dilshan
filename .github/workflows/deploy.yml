name: Deploy to AWS EC2 (Docker)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy with Docker Compose
    runs-on: ubuntu-latest
    steps:
      - name: Configure SSH Key
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf '%s\n' "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key.pem
          chmod 400 ~/.ssh/deploy_key.pem

      - name: Add SSH Config
        run: |
          cat > ~/.ssh/config <<EOF
          Host ec2
            HostName ${{ secrets.EC2_HOST }}
            User ${{ secrets.EC2_USER }}
            IdentityFile ~/.ssh/deploy_key.pem
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
            ServerAliveInterval 60
            ServerAliveCountMax 10
          EOF
          chmod 600 ~/.ssh/config

      - name: Test SSH Connection
        run: |
          echo "Testing SSH connection to EC2..."
          ssh -o ConnectTimeout=10 ec2 'echo "SSH connection successful!"'

      - name: Deploy via Docker Compose
        run: |
          ssh -o StrictHostKeyChecking=no ec2 'bash -s' <<'EOF'
            set -e
            APP_DIR="/var/www/hms-app"

            if [ ! -d "$APP_DIR/.git" ]; then
              echo "Error: Repo not found at $APP_DIR"
              exit 1
            fi

            echo "Updating repository..."
            cd "$APP_DIR"
            git fetch --all
            git reset --hard origin/main
            git clean -fd

            echo "Ensuring Docker and Compose are installed..."
            if ! command -v docker >/dev/null 2>&1; then
              sudo apt-get update
              sudo apt-get install -y docker.io
              sudo systemctl enable --now docker
            fi

            if ! docker compose version >/dev/null 2>&1; then
              sudo apt-get update
              sudo apt-get install -y docker-compose-plugin
            fi

            echo "Deploying containers with docker-compose.prod.yml..."
            docker compose -f docker-compose.prod.yml up -d --build --remove-orphans

            echo "Deployment finished successfully!"
          EOF
