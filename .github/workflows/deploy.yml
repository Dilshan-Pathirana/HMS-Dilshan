name: Deploy to AWS EC2

on:
  push:
    branches:
      - main

jobs:
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PHP 8.4
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv, imagick, fileinfo
          coverage: none

      - name: Install Composer Dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist

      - name: Optimize Laravel Caches
        run: |
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache || true

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install NPM Dependencies
        run: npm install --legacy-peer-deps

      - name: Build Frontend Assets
        run: npm run build

      - name: Verify Build Output
        run: |
          if [ ! -d "public/build" ]; then
            echo "Error: Build output directory not found!"
            exit 1
          fi
          echo "Build output exists. Contents:"
          ls -la public/build/

      - name: Upload Frontend Build for Deployment
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: public/build/
          if-no-files-found: error
          retention-days: 1

  deploy:
    name: Deploy to EC2
    needs: [build-backend, build-frontend]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Frontend Build
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: ./frontend-dist

      - name: Configure SSH Key
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          # Restore multi-line PEM from GitHub secret (using printf for better handling)
          printf '%s\n' "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key.pem
          chmod 400 ~/.ssh/deploy_key.pem
          # Verify key format
          echo "Verifying SSH key format..."
          head -1 ~/.ssh/deploy_key.pem
          tail -1 ~/.ssh/deploy_key.pem

      - name: Add SSH Config
        run: |
          cat > ~/.ssh/config <<EOF
          Host ec2
            HostName ${{ secrets.EC2_HOST }}
            User ${{ secrets.EC2_USER }}
            IdentityFile ~/.ssh/deploy_key.pem
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
            ServerAliveInterval 60
            ServerAliveCountMax 10
          EOF
          chmod 600 ~/.ssh/config
          echo "SSH config created:"
          cat ~/.ssh/config

      - name: Verify Downloaded Artifact
        run: |
          echo "Checking downloaded frontend artifacts:"
          ls -la ./frontend-dist/
          echo "Total files to transfer:"
          find ./frontend-dist -type f | wc -l
          
      - name: Test SSH Connection
        run: |
          echo "Testing SSH connection to EC2..."
          ssh -v -o ConnectTimeout=10 ec2 'echo "SSH connection successful!"' || {
            echo "SSH connection failed. Debugging info:"
            echo "Host: ${{ secrets.EC2_HOST }}"
            echo "User: ${{ secrets.EC2_USER }}"
            cat ~/.ssh/deploy_key.pem | head -1
            exit 1
          }
          
      - name: Prepare Remote Directory
        run: |
          echo "Creating remote directory for frontend files..."
          ssh ec2 'mkdir -p /tmp/frontend-dist-new && echo "Directory created successfully"'
          
      - name: Transfer Frontend Build to EC2
        run: |
          echo "Transferring frontend build to EC2..."
          scp -v -r ./frontend-dist/* ec2:/tmp/frontend-dist-new/
          echo "Verifying files were transferred..."
          ssh ec2 'ls -la /tmp/frontend-dist-new/'

      - name: Deploy Backend & Frontend to EC2
        run: |
          ssh -o StrictHostKeyChecking=no ec2 'bash -s' <<'EOF'
            set -e

            APP_DIR="/var/www/hms-app"

            # Clone repo if not exists
            if [ ! -d "$APP_DIR" ]; then
              echo "Project directory not found at $APP_DIR. Cloning repo..."
              git clone git@github.com:Dilshan-Pathirana/HMS-Dilshan.git "$APP_DIR"
            fi

            cd "$APP_DIR"

            echo "Resetting local changes and pulling latest code..."
            git reset --hard
            git pull origin main

            echo "Installing backend dependencies..."
            composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist

            echo "Configuring environment for MySQL..."
            # Create .env if missing
            if [ ! -f .env ]; then
              cp .env.example .env
            fi

            # Update .env with Production DB Credentials
            # Note: We use sed to replace existing values or append if missing
            sed -i "s/^DB_CONNECTION=.*/DB_CONNECTION=mysql/" .env
            sed -i "s/^.*\bDB_HOST=.*/DB_HOST=${{ secrets.DB_HOST }}/" .env
            sed -i "s/^.*\bDB_PORT=.*/DB_PORT=3306/" .env
            sed -i "s/^.*\bDB_DATABASE=.*/DB_DATABASE=${{ secrets.DB_DATABASE }}/" .env
            sed -i "s/^.*\bDB_USERNAME=.*/DB_USERNAME=${{ secrets.DB_USERNAME }}/" .env
            sed -i "s/^.*\bDB_PASSWORD=.*/DB_PASSWORD=${{ secrets.DB_PASSWORD }}/" .env

            echo "Running migrations..."
            php artisan migrate --force

            echo "Caching configs..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache || true

            echo "Deploying frontend assets..."
            if [ -d "/tmp/frontend-dist-new" ]; then
              rsync -avz --delete /tmp/frontend-dist-new/ /var/www/hms-app/public/
              rm -rf /tmp/frontend-dist-new
            else
              echo "Warning: Frontend build not found, skipping frontend deployment"
            fi

            echo "Setting permissions..."
            sudo chown -R www-data:www-data storage bootstrap/cache public
            sudo chmod -R 775 storage bootstrap/cache public

            echo "Restarting Nginx..."
            sudo systemctl restart nginx

            echo "Restarting Laravel queue workers..."
            if systemctl is-active --quiet supervisor; then
               sudo supervisorctl restart hms-worker:*
            else
               echo "Supervisor not running, skipping worker restart."
            fi

            echo "Deployment finished successfully!"
          EOF
