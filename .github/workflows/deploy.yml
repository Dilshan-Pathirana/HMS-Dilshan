name: Build & Deploy to AWS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build backend image
        run: |
          docker build -t hms-backend:latest -f backend/Dockerfile backend

      - name: Build frontend image
        run: |
          docker build -t hms-frontend:latest -f frontend/Dockerfile --build-arg VITE_API_BASE_URL="" frontend

      - name: Save docker images
        run: |
          docker save hms-backend:latest hms-frontend:latest | gzip > hms-images.tar.gz

      - name: Upload docker images and compose file to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "hms-images.tar.gz,docker-compose.ec2.yml"
          target: "/tmp"

      # Deploy via SSH
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_DATABASE: ${{ secrets.DB_DATABASE }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: DB_HOST,DB_PORT,DB_DATABASE,DB_USERNAME,DB_PASSWORD,SECRET_KEY
          script: |
            set -e
            APP_DIR=${APP_DIR:-/var/www/hms}
            mkdir -p $APP_DIR

            # Ensure Docker is installed
            if ! command -v docker >/dev/null 2>&1; then
              sudo apt-get update
              sudo apt-get install -y docker.io
              sudo systemctl enable --now docker
            fi

            # Ensure Docker Compose plugin is installed
            if ! docker compose version >/dev/null 2>&1; then
              sudo apt-get update
              sudo apt-get install -y docker-compose-plugin
            fi

            # Load images built on the runner
            docker load -i /tmp/hms-images.tar.gz

            # Prepare compose and env file
            mv /tmp/docker-compose.ec2.yml $APP_DIR/docker-compose.ec2.yml
            echo "DATABASE_URL=mysql+asyncmy://$DB_USERNAME:$DB_PASSWORD@$DB_HOST:$DB_PORT/$DB_DATABASE" > $APP_DIR/.env
            echo "SECRET_KEY=$SECRET_KEY" >> $APP_DIR/.env

            # Run migrations
            docker compose -f $APP_DIR/docker-compose.ec2.yml --env-file $APP_DIR/.env run --rm backend alembic upgrade head

            # Start services
            docker compose -f $APP_DIR/docker-compose.ec2.yml --env-file $APP_DIR/.env up -d --remove-orphans

            # Cleanup old images
            docker image prune -f
