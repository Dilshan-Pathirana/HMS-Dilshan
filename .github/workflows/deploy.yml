name: Deploy to AWS EC2

on:
  push:
    branches:
      - main

jobs:
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PHP 8.4
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv, imagick, fileinfo
          coverage: none

      - name: Install Composer Dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist

      - name: Optimize Laravel Caches
        run: |
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install NPM Dependencies
        run: npm ci

      - name: Build Frontend Assets
        run: npm run build

  deploy:
    name: Deploy to EC2
    needs: [build-backend, build-frontend]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh/
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key.pem
          chmod 400 ~/.ssh/deploy_key.pem
          cat >>~/.ssh/config <<END
Host ec2
  HostName ${{ secrets.EC2_HOST }}
  User ${{ secrets.EC2_USER }}
  IdentityFile ~/.ssh/deploy_key.pem
  StrictHostKeyChecking no
END

      - name: Deploy to Server
        run: |
          ssh ec2 'bash -s' << 'EOF'
            set -e

            APP_DIR="/var/www/hms-app"

            if [ ! -d "$APP_DIR" ]; then
              echo "Project directory not found at $APP_DIR. Please ensure the repo is cloned there."
              exit 1
            fi

            cd $APP_DIR

            echo "Pulling latest code..."
            git reset --hard
            git pull origin main

            echo "Installing Composer dependencies..."
            composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist

            echo "Installing frontend dependencies and building assets..."
            npm ci
            npm run build

            echo "Running database migrations..."
            php artisan migrate --force

            echo "Optimizing caches..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            echo "Setting file permissions..."
            sudo chown -R www-data:www-data storage bootstrap/cache
            sudo chmod -R 775 storage bootstrap/cache

            echo "Restarting Nginx..."
            sudo systemctl restart nginx

            echo "Restarting Laravel queue workers..."
            if systemctl is-active --quiet supervisor; then
               sudo supervisorctl restart hms-worker:*
            else
               echo "Supervisor not running, skipping worker restart."
            fi

            echo "Deployment finished successfully!"
          EOF
