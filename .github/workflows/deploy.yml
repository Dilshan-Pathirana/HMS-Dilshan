name: Build & Deploy to AWS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------- BUILD IMAGES ----------
      - name: Build backend image
        run: docker build -t hms-backend:latest -f backend/Dockerfile backend

      - name: Build frontend image
        run: docker build -t hms-frontend:latest -f frontend/Dockerfile frontend

      - name: Save images
        run: docker save hms-backend hms-frontend | gzip > hms-images.tar.gz

      # ---------- COPY TO EC2 ----------
      - name: Upload images & compose
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "hms-images.tar.gz,docker-compose.ec2.yml"
          target: "/tmp"

      # ---------- DEPLOY ----------
      - name: Deploy containers (NO DB ACCESS)
        uses: appleboy/ssh-action@v1.0.3
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_DATABASE: ${{ secrets.DB_DATABASE }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          SMS_USER: ${{ secrets.SMS_USER }}
          SMS_PASSWORD: ${{ secrets.SMS_PASSWORD }}
          SMS_URL: ${{ secrets.SMS_URL }}
          SMS_SENDER_ID: ${{ secrets.SMS_SENDER_ID }}
          PAYHERE_MERCHANT_ID: ${{ secrets.PAYHERE_MERCHANT_ID }}
          PAYHERE_MERCHANT_SECRET: ${{ secrets.PAYHERE_MERCHANT_SECRET }}
          PAYHERE_CURRENCY: ${{ secrets.PAYHERE_CURRENCY }}
          PAYHERE_SANDBOX: ${{ secrets.PAYHERE_SANDBOX }}

        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: DB_HOST,DB_PORT,DB_DATABASE,DB_USERNAME,DB_PASSWORD,SECRET_KEY,SMS_USER,SMS_PASSWORD,SMS_URL,SMS_SENDER_ID,PAYHERE_MERCHANT_ID,PAYHERE_MERCHANT_SECRET,PAYHERE_CURRENCY,PAYHERE_SANDBOX

          script: |
            set -e

            APP_DIR=/var/www/hms
            mkdir -p $APP_DIR

            echo "==== Load images ===="
            docker load -i /tmp/hms-images.tar.gz

            echo "==== Move compose file ===="
            mv -f /tmp/docker-compose.ec2.yml $APP_DIR/docker-compose.ec2.yml

            echo "==== Write env ===="
            cat > $APP_DIR/.env <<EOF
            DB_HOST=$DB_HOST
            DB_PORT=$DB_PORT
            DB_DATABASE=$DB_DATABASE
            DB_USERNAME=$DB_USERNAME
            DB_PASSWORD=$DB_PASSWORD
            SECRET_KEY=$SECRET_KEY
            SMS_USER=$SMS_USER
            SMS_PASSWORD=$SMS_PASSWORD
            SMS_URL=$SMS_URL
            SMS_SENDER_ID=$SMS_SENDER_ID
            DATABASE_URL=mysql+asyncmy://$DB_USERNAME:$DB_PASSWORD@$DB_HOST:$DB_PORT/$DB_DATABASE
            BACKEND_CORS_ORIGINS=http://13.233.254.140,http://13.233.254.140:80,http://localhost
            PAYHERE_MERCHANT_ID=$PAYHERE_MERCHANT_ID
            PAYHERE_MERCHANT_SECRET=$PAYHERE_MERCHANT_SECRET
            PAYHERE_CURRENCY=$PAYHERE_CURRENCY
            PAYHERE_SANDBOX=$PAYHERE_SANDBOX
            EOF

            echo "==== Restart containers only ===="
            docker compose -f $APP_DIR/docker-compose.ec2.yml down --remove-orphans || true

            docker compose \
              -f $APP_DIR/docker-compose.ec2.yml \
              --env-file $APP_DIR/.env \
              up -d --remove-orphans

            echo "==== Status ===="
            docker compose -f $APP_DIR/docker-compose.ec2.yml ps

            echo "==== Backend logs ===="
            docker compose -f $APP_DIR/docker-compose.ec2.yml logs --tail=50 backend

            echo "==== Cleanup ===="
            rm -f /tmp/hms-images.tar.gz
            docker image prune -f

            echo "==== Deployment complete (DB untouched) ===="
