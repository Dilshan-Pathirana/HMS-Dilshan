name: Build & Deploy to AWS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  backend-migrations-and-seed:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: hms_ci
          MYSQL_USER: hms
          MYSQL_PASSWORD: hms_pass
          MYSQL_ROOT_PASSWORD: root_pass
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -uroot -proot_pass"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Poetry
        run: pip install poetry

      - name: Install backend dependencies
        working-directory: backend
        run: poetry install --no-interaction --no-ansi

      - name: Install aiosqlite
        working-directory: backend
        run: poetry run pip install aiosqlite

      - name: Run Alembic migrations
        working-directory: backend
        env:
          DATABASE_URL: mysql+asyncmy://hms:hms_pass@127.0.0.1:3306/hms_ci
          SECRET_KEY: ci-secret-key
        run: |
          if [ -f alembic.ini ]; then
            poetry run alembic upgrade head
          else
            echo "No alembic.ini found; skipping migrations."
          fi

      - name: Seed database
        working-directory: backend
        env:
          DATABASE_URL: mysql+asyncmy://hms:hms_pass@127.0.0.1:3306/hms_ci
          SECRET_KEY: ci-secret-key
        run: poetry run python seed.py

  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------------- BUILD IMAGES ----------------
      - name: Build backend
        run: docker build -t hms-backend:latest -f backend/Dockerfile backend

      - name: Build frontend
        run: docker build -t hms-frontend:latest -f frontend/Dockerfile frontend

      - name: Save images
        run: docker save hms-backend hms-frontend | gzip > hms-images.tar.gz

      # ---------------- COPY TO EC2 ----------------
      - name: Upload to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "hms-images.tar.gz,docker-compose.ec2.yml"
          target: "/tmp"

      # ---------------- DEPLOY ----------------
      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.0.3
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_DATABASE: ${{ secrets.DB_DATABASE }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          SMS_USER: ${{ secrets.SMS_USER }}
          SMS_PASSWORD: ${{ secrets.SMS_PASSWORD }}
          SMS_URL: ${{ secrets.SMS_URL }}
          SMS_SENDER_ID: ${{ secrets.SMS_SENDER_ID }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: DB_HOST,DB_PORT,DB_DATABASE,DB_USERNAME,DB_PASSWORD,SECRET_KEY,SMS_USER,SMS_PASSWORD,SMS_URL,SMS_SENDER_ID

          script: |
            set -e

            APP_DIR=/var/www/hms
            mkdir -p $APP_DIR

            echo "==== Load Docker images ===="
            docker load -i /tmp/hms-images.tar.gz

            echo "==== Move compose file ===="
            mv -f /tmp/docker-compose.ec2.yml $APP_DIR/docker-compose.ec2.yml

            echo "==== Write .env ===="
            cat > $APP_DIR/.env <<EOF
            DB_HOST=$DB_HOST
            DB_PORT=$DB_PORT
            DB_DATABASE=$DB_DATABASE
            DB_USERNAME=$DB_USERNAME
            DB_PASSWORD=$DB_PASSWORD
            SECRET_KEY=$SECRET_KEY
            SMS_USER=$SMS_USER
            SMS_PASSWORD=$SMS_PASSWORD
            SMS_URL=$SMS_URL
            SMS_SENDER_ID=$SMS_SENDER_ID
            DATABASE_URL=mysql+asyncmy://$DB_USERNAME:$DB_PASSWORD@$DB_HOST:$DB_PORT/$DB_DATABASE
            EOF

            echo "==== Remove old containers ===="
            docker compose -f $APP_DIR/docker-compose.ec2.yml down --remove-orphans || true

            echo "==== Test RDS connectivity ===="
            sudo apt-get update -y >/dev/null 2>&1 || true
            sudo apt-get install -y mysql-client >/dev/null 2>&1 || true
            mysql -h $DB_HOST -u $DB_USERNAME -p$DB_PASSWORD -e "SELECT 1" && echo "RDS reachable"

            echo "==== Run DB schema migrations ===="
            mysql -h $DB_HOST -u $DB_USERNAME -p$DB_PASSWORD $DB_DATABASE <<'MIGRATION'
            ALTER TABLE product
              ADD COLUMN IF NOT EXISTS item_code VARCHAR(100) DEFAULT NULL,
              ADD COLUMN IF NOT EXISTS barcode VARCHAR(100) DEFAULT NULL,
              ADD COLUMN IF NOT EXISTS brand_name VARCHAR(255) DEFAULT NULL,
              ADD COLUMN IF NOT EXISTS current_stock INT DEFAULT 0,
              ADD COLUMN IF NOT EXISTS min_stock INT DEFAULT 0,
              ADD COLUMN IF NOT EXISTS reorder_level INT DEFAULT 0,
              ADD COLUMN IF NOT EXISTS reorder_quantity INT DEFAULT 0,
              ADD COLUMN IF NOT EXISTS unit_cost DECIMAL(12,2) DEFAULT 0.00,
              ADD COLUMN IF NOT EXISTS unit_selling_price DECIMAL(12,2) DEFAULT 0.00,
              ADD COLUMN IF NOT EXISTS expiry_date VARCHAR(20) DEFAULT NULL,
              ADD COLUMN IF NOT EXISTS product_store_location VARCHAR(255) DEFAULT NULL,
              ADD COLUMN IF NOT EXISTS warranty_serial VARCHAR(100) DEFAULT NULL,
              ADD COLUMN IF NOT EXISTS warranty_duration VARCHAR(50) DEFAULT NULL,
              ADD COLUMN IF NOT EXISTS warranty_type VARCHAR(50) DEFAULT NULL;

            ALTER TABLE supplier
              ADD COLUMN IF NOT EXISTS supplier_city VARCHAR(255) DEFAULT NULL,
              ADD COLUMN IF NOT EXISTS supplier_country VARCHAR(255) DEFAULT NULL,
              ADD COLUMN IF NOT EXISTS supplier_type VARCHAR(100) DEFAULT NULL,
              ADD COLUMN IF NOT EXISTS products_supplied TEXT DEFAULT NULL,
              ADD COLUMN IF NOT EXISTS delivery_time VARCHAR(100) DEFAULT NULL,
              ADD COLUMN IF NOT EXISTS bank_details TEXT DEFAULT NULL,
              ADD COLUMN IF NOT EXISTS rating VARCHAR(20) DEFAULT NULL,
              ADD COLUMN IF NOT EXISTS discounts_agreements TEXT DEFAULT NULL,
              ADD COLUMN IF NOT EXISTS return_policy TEXT DEFAULT NULL,
              ADD COLUMN IF NOT EXISTS note TEXT DEFAULT NULL;
            MIGRATION
            echo "Schema migration complete"

            echo "==== Skip RDS migrations/seed/truncate ===="
            echo "RDS data preserved as requested"

            echo "==== Start services ===="
            docker compose \
              -f $APP_DIR/docker-compose.ec2.yml \
              --env-file $APP_DIR/.env \
              up -d --remove-orphans

            echo "==== Wait for backend ===="
            sleep 12
            docker compose -f $APP_DIR/docker-compose.ec2.yml ps

            echo "==== Backend logs ===="
            docker compose -f $APP_DIR/docker-compose.ec2.yml logs --tail=50 backend

            echo "==== Cleanup ===="
            rm -f /tmp/hms-images.tar.gz
            rm -f /tmp/trunc.sql /tmp/trunc.out
            docker image prune -f

            echo "==== Deployment Complete ===="
