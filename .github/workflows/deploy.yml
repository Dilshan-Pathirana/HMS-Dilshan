name: Build & Deploy to AWS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  backend-migrations-and-seed:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Poetry
        run: pip install poetry

      - name: Install backend dependencies
        working-directory: backend
        run: poetry install --no-interaction --no-ansi

      - name: Install aiosqlite
        working-directory: backend
        run: poetry run pip install aiosqlite

      - name: Run Alembic migrations
        working-directory: backend
        env:
          DATABASE_URL: sqlite+aiosqlite:///./ci.db
          SECRET_KEY: ci-secret-key
        run: |
          if [ -f alembic.ini ]; then
            poetry run alembic upgrade head
          else
            echo "No alembic.ini found; skipping migrations."
          fi

      - name: Seed database
        working-directory: backend
        env:
          DATABASE_URL: sqlite+aiosqlite:///./ci.db
          SECRET_KEY: ci-secret-key
        run: poetry run python seed.py

  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------------- BUILD IMAGES ----------------
      - name: Build backend
        run: docker build -t hms-backend:latest -f backend/Dockerfile backend

      - name: Build frontend
        run: docker build -t hms-frontend:latest -f frontend/Dockerfile frontend

      - name: Save images
        run: docker save hms-backend hms-frontend | gzip > hms-images.tar.gz

      # ---------------- COPY TO EC2 ----------------
      - name: Upload to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "hms-images.tar.gz,docker-compose.ec2.yml"
          target: "/tmp"

      # ---------------- DEPLOY ----------------
      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.0.3
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_DATABASE: ${{ secrets.DB_DATABASE }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          SMS_USER: ${{ secrets.SMS_USER }}
          SMS_PASSWORD: ${{ secrets.SMS_PASSWORD }}
          SMS_URL: ${{ secrets.SMS_URL }}
          SMS_SENDER_ID: ${{ secrets.SMS_SENDER_ID }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: DB_HOST,DB_PORT,DB_DATABASE,DB_USERNAME,DB_PASSWORD,SECRET_KEY,SMS_USER,SMS_PASSWORD,SMS_URL,SMS_SENDER_ID

          script: |
            set -e

            APP_DIR=/var/www/hms
            mkdir -p $APP_DIR

            echo "==== Load Docker images ===="
            docker load -i /tmp/hms-images.tar.gz

            echo "==== Move compose file ===="
            mv -f /tmp/docker-compose.ec2.yml $APP_DIR/docker-compose.ec2.yml

            echo "==== Write .env ===="
            cat > $APP_DIR/.env <<EOF
            DB_HOST=$DB_HOST
            DB_PORT=$DB_PORT
            DB_DATABASE=$DB_DATABASE
            DB_USERNAME=$DB_USERNAME
            DB_PASSWORD=$DB_PASSWORD
            SECRET_KEY=$SECRET_KEY
            SMS_USER=$SMS_USER
            SMS_PASSWORD=$SMS_PASSWORD
            SMS_URL=$SMS_URL
            SMS_SENDER_ID=$SMS_SENDER_ID
            DATABASE_URL=mysql+asyncmy://$DB_USERNAME:$DB_PASSWORD@$DB_HOST:$DB_PORT/$DB_DATABASE
            EOF

            echo "==== Remove old containers ===="
            docker compose -f $APP_DIR/docker-compose.ec2.yml down --remove-orphans || true

            echo "==== Test RDS connectivity ===="
            sudo apt-get update -y >/dev/null 2>&1 || true
            sudo apt-get install -y mysql-client >/dev/null 2>&1 || true
            mysql -h $DB_HOST -u $DB_USERNAME -p$DB_PASSWORD -e "SELECT 1" && echo "RDS reachable"

            echo "==== Run migrations ===="
            docker compose \
              -f $APP_DIR/docker-compose.ec2.yml \
              --env-file $APP_DIR/.env \
              run --rm backend alembic upgrade heads

            echo "==== Truncate RDS data ===="
            mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -N \
              -e "SELECT CONCAT('TRUNCATE TABLE ', CHAR(96), table_name, CHAR(96), ';') FROM information_schema.tables WHERE table_schema='$DB_DATABASE' AND table_type='BASE TABLE' AND table_name != 'alembic_version';" \
              > /tmp/trunc.out || true

            if [ -s /tmp/trunc.out ]; then
              { echo "SET FOREIGN_KEY_CHECKS=0;"; cat /tmp/trunc.out; echo "SET FOREIGN_KEY_CHECKS=1;"; } | \
                mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" "$DB_DATABASE"
            fi
            echo "RDS truncate complete"

            echo "==== Seed database ===="
            docker compose \
              -f $APP_DIR/docker-compose.ec2.yml \
              --env-file $APP_DIR/.env \
              run --rm backend python comprehensive_seed.py

            echo "==== Start services ===="
            docker compose \
              -f $APP_DIR/docker-compose.ec2.yml \
              --env-file $APP_DIR/.env \
              up -d --remove-orphans

            echo "==== Wait for backend ===="
            sleep 12
            docker compose -f $APP_DIR/docker-compose.ec2.yml ps

            echo "==== Backend logs ===="
            docker compose -f $APP_DIR/docker-compose.ec2.yml logs --tail=50 backend

            echo "==== Cleanup ===="
            rm -f /tmp/hms-images.tar.gz
            rm -f /tmp/trunc.sql /tmp/trunc.out
            docker image prune -f

            echo "==== Deployment Complete ===="
